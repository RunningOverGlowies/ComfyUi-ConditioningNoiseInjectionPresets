<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Noise Logic Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #222;
            --panel: #333;
            --text: #ddd;
            --accent: #5577ff;
            --safe: rgba(0, 255, 100, 0.15);
            --safe-border: rgba(0, 255, 100, 0.5);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        h2 { margin-top: 0; }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1000px;
            width: 100%;
        }
        .controls {
            flex: 1;
            min-width: 300px;
            background: var(--panel);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .graph-container {
            flex: 2;
            min-width: 300px;
            background: var(--panel);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            height: 400px;
            position: relative;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #555;
            font-size: 0.9em;
            color: #aaa;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .val-highlight {
            color: #fff;
            font-family: monospace;
        }
        .legend {
            margin-top: 10px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-box {
            width: 15px;
            height: 15px;
            background: var(--safe);
            border: 1px dashed var(--safe-border);
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- CONTROLS -->
        <div class="controls">
            <h2>Parameters</h2>
            
            <div class="control-group">
                <label>Steps <span id="val_steps" class="val-highlight">12</span></label>
                <input type="range" id="steps" min="4" max="50" value="12" step="1">
            </div>

            <div class="control-group">
                <label>Num Segments <span id="val_segments" class="val-highlight">3</span></label>
                <input type="range" id="num_segments" min="1" max="10" value="3" step="1">
            </div>

            <div class="control-group">
                <label>Chaos Factor <span id="val_chaos" class="val-highlight">0.5</span></label>
                <input type="range" id="chaos_factor" min="0.0" max="1.0" value="0.5" step="0.01">
            </div>

            <div class="control-group">
                <label>Strength Scale <span id="val_scale" class="val-highlight">1.0</span></label>
                <input type="range" id="strength_scale" min="0.0" max="2.0" value="1.0" step="0.1">
            </div>

            <div class="stats">
                <div class="stat-row"><span>Calculated Duration:</span> <span id="calc_duration" class="val-highlight">-</span></div>
                <div class="stat-row"><span>Peak Strength:</span> <span id="calc_peak" class="val-highlight">-</span></div>
                <div class="stat-row"><span>Curve Type:</span> <span id="calc_type" class="val-highlight">-</span></div>
            </div>

            <div class="legend">
                <div class="legend-box"></div>
                <span>Safe Zone (Str < 1.6, Time < 37%)</span>
            </div>
        </div>

        <!-- GRAPH -->
        <div class="graph-container">
            <canvas id="noiseChart"></canvas>
        </div>
    </div>

<script>
    // ==========================================
    // 1. LOGIC
    // ==========================================
    function calculateCurve(steps, num_segments, chaos_factor, strength_scale) {
        const step_len = 1.0 / Math.max(1, steps);
        const min_duration = step_len * 1.5;
        const max_duration = 0.60;
        let target_duration = min_duration + (max_duration - min_duration) * chaos_factor;
        target_duration = Math.min(target_duration, 1.0);

        const min_peak = 2.0;
        const max_peak = 20.0;
        const peak_strength = min_peak + (max_peak - min_peak) * chaos_factor;

        const chunk_size = target_duration / num_segments;
        const graphData = [];

        let current_time = 0.0;

        for (let i = 0; i < num_segments; i++) {
            const start = current_time;
            const end = current_time + chunk_size;
            const progress = (num_segments > 1) ? (i / (num_segments - 1)) : 0.0;
            const segment_strength = peak_strength * (1.0 - (progress * 0.9));
            const final_strength = segment_strength * strength_scale;

            graphData.push({ x: start, y: final_strength });
            graphData.push({ x: end, y: final_strength });
            current_time = end;
        }
        graphData.push({ x: current_time, y: 0 });
        graphData.push({ x: 1.0, y: 0 });

        return {
            data: graphData,
            meta: {
                duration: target_duration,
                peak: peak_strength * strength_scale
            }
        };
    }

    // ==========================================
    // 2. CHART PLUGINS
    // ==========================================
    const ctx = document.getElementById('noiseChart').getContext('2d');

    const backgroundPlugins = {
        id: 'bgLayers',
        beforeDraw: (chart) => {
            const steps = parseInt(document.getElementById('steps').value);
            const { ctx, chartArea: {top, bottom, left, right, width, height}, scales: {x, y} } = chart;

            ctx.save();

            // --- A. Draw Safe Zone ---
            const safeTime = 0.37;
            const safeStrength = 16.45;

            const xStart = x.getPixelForValue(0);
            const xEnd = x.getPixelForValue(safeTime);
            const yStart = y.getPixelForValue(safeStrength);
            const yEnd = y.getPixelForValue(0);

            const rectW = xEnd - xStart;
            const rectH = yEnd - yStart;

            ctx.fillStyle = 'rgba(0, 255, 100, 0.05)';
            ctx.fillRect(xStart, yStart, rectW, rectH);

            ctx.strokeStyle = 'rgba(0, 255, 100, 0.4)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.strokeRect(xStart, yStart, rectW, rectH);

            // Label
            ctx.fillStyle = 'rgba(0, 255, 100, 0.8)';
            ctx.font = '11px Arial';
            ctx.fillText("SAFE ZONE", xStart + 5, yStart - 5);


            // --- B. Draw Step Grid ---
            ctx.strokeStyle = '#444'; 
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 4]);

            const stepSize = 1.0 / steps;
            for (let i = 1; i < steps; i++) {
                const xVal = i * stepSize;
                const xPos = x.getPixelForValue(xVal);
                
                // Don't draw outside chart area
                if(xPos > right) break;

                ctx.beginPath();
                ctx.moveTo(xPos, top);
                ctx.lineTo(xPos, bottom);
                ctx.stroke();

                // Step number
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(i, xPos, bottom + 12);
            }

            ctx.restore();
        }
    };

    // ==========================================
    // 3. CHART INIT
    // ==========================================
    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Noise Strength',
                data: [],
                showLine: true,
                borderColor: '#5577ff',
                backgroundColor: 'rgba(85, 119, 255, 0.2)',
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 1,
                    title: { display: true, text: 'Generation Progress (0.0 to 1.0)' },
                    grid: { display: false } // Custom grid
                },
                y: {
                    min: 0,
                    max: 25, // Fixed max to make visual comparison stable
                    title: { display: true, text: 'Strength' },
                    grid: { color: '#333' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'nearest',
                    intersect: false,
                    callbacks: {
                        label: (context) => `Strength: ${context.parsed.y.toFixed(2)}`
                    }
                }
            }
        },
        plugins: [backgroundPlugins]
    });

    // ==========================================
    // 4. UI INTERACTION
    // ==========================================
    const inputs = {
        steps: document.getElementById('steps'),
        num_segments: document.getElementById('num_segments'),
        chaos_factor: document.getElementById('chaos_factor'),
        strength_scale: document.getElementById('strength_scale')
    };

    const displays = {
        steps: document.getElementById('val_steps'),
        num_segments: document.getElementById('val_segments'),
        chaos_factor: document.getElementById('val_chaos'),
        strength_scale: document.getElementById('val_scale'),
        
        calc_duration: document.getElementById('calc_duration'),
        calc_peak: document.getElementById('calc_peak'),
        calc_type: document.getElementById('calc_type')
    };

    function update() {
        const steps = parseInt(inputs.steps.value);
        const segments = parseInt(inputs.num_segments.value);
        const chaos = parseFloat(inputs.chaos_factor.value);
        const scale = parseFloat(inputs.strength_scale.value);

        displays.steps.innerText = steps;
        displays.num_segments.innerText = segments;
        displays.chaos_factor.innerText = chaos.toFixed(2);
        displays.strength_scale.innerText = scale.toFixed(1);

        const result = calculateCurve(steps, segments, chaos, scale);

        const durPercent = (result.meta.duration * 100).toFixed(0);
        const stepsCovered = (result.meta.duration * steps).toFixed(1);
        
        displays.calc_duration.innerText = `${durPercent}% (${stepsCovered} steps)`;
        displays.calc_peak.innerText = result.meta.peak.toFixed(2);
        
        // Warn if outside safe zone
        const peak = result.meta.peak;
        const dur = result.meta.duration;
        let typeText = "Balanced";
        let color = "#00ff66";
        
		if (peak >= 16.44 && dur <= 0.36) {
            typeText = "Chaotic";
            color = "#FFBF00";
        } else if (peak <= 16.44 && dur >= 0.36) {
            typeText = "Chaotic";
            color = "#FFBF00";
        } else if (peak >= 16.44 && dur >= 0.36) {
            typeText = "High Chaos";
            color = "#ff5555";
        } else if (chaos > 0.7) {
            typeText = "High Chaos";
            color = "#ff5555";
        } else {
			typeText = "Balanced";
			color = "#00ff66";
		}

        displays.calc_type.innerText = typeText;
        displays.calc_type.style.color = color;

        chart.data.datasets[0].data = result.data;
        chart.update();
    }

    Object.values(inputs).forEach(el => el.addEventListener('input', update));
    update();

</script>
</body>
</html>